<!DOCTYPE html>
<html>
	<head>
		<title>Chat</title>
		<script src="https://cdn.socket.io/socket.io-1.0.0.js"></script>
		<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles_room.css') }}">
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
		<script>
			document.addEventListener('DOMContentLoaded', function(){
				var socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port);

				socket.on('connect', function(){
					socket.emit('joined_room', {
						username: "{{ username }}",
						channel: "{{ channel }}"
					});

					
					document.querySelector('#sendMessage').onsubmit = function(e){
						e.preventDefault();
						let dateObj = new Date();
						let time = dateObj.getHours() + ":" + dateObj.getMinutes() + ":" + dateObj.getSeconds();
						let message = document.querySelector('#message').value;
						let user = "{{ username }}";

						if(message.length > 0){
							socket.emit('sent_message', {
								username: "{{ username }}",
								channel: "{{ channel }}",
								message: [user, message, time]
							})
						}

						document.querySelector('#message').value = '';
					}

				});

				socket.on('new_user_announce', function(data){
					let userList = document.createElement('li');
					userList.innerHTML = `<strong>${data['username']}</strong> has joined the room`;
					document.querySelector('#currUsers').append(userList);

				});

				socket.on('receiveMessage', function(data){
					let messageDisplay = document.createElement('li');
					let localUser = '{{ username }}';
					let user = data['message'][0];
					let message = data['message'][1];
					let time = data['message'][2];
					if(localUser === user){
						messageDisplay.innerHTML = `****<strong>${user}</strong>: ${message} - <i>${time}</i>`;
					}
					else{
						messageDisplay.innerHTML = `<strong>${user}</strong>: ${message} - <i>${time}</i>`;
					}

					
					document.querySelector('#currUsers').append(messageDisplay);
				});

			});
		</script>

	</head>
	<body>
		<nav class="navbar navbar-expand-lg navbar-light bg-light">
			<a class="navbar-brand" href="#">
				<img src="{{ url_for('static', filename='globeIcon.png') }}" width="30" height="30" class="d-inline-block align-center" alt="" loading="lazy">
				Flack
			</a>
		    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
		    	<span class="navbar-toggler-icon"></span>
		    </button>
	    	<div class="collapse navbar-collapse" id="navbarNavAltMarkup">
		    	<div class="navbar-nav">
		    		<a class="nav-item nav-link" href="{{ url_for('index') }}">Home</a>
			        <a class="nav-item nav-link active" href="#">{{ channel }} <span class="sr-only">(current)</span></a>
			        <a class="nav-item nav-link" href="#">About</a>
			        <a class="nav-item nav-link" href="#">Code</a>
	    		</div>
	    	</div>
		</nav>

		<h1>#Channel: {{ channel }}</h1>
		<h3>Welcome {{ username }}</h3>

		<ul id="currUsers">
			{% for i in chatMsgs %}
				<li><strong>{{ i[0] }}</strong>: {{ i[1] }} - <i>{{ i[2] }}</i></li>
			{% endfor %}
		</ul>

		<form id="sendMessage">
			<input id="message" type="text" placeholder="Message">
			<button>Send</button>
		</form>
		<br>
		<a href="{{ url_for('chats') }}">Go Back to Channels</a>

	</body>
</html>