<!DOCTYPE html>
<html>
	<head>
		<title>Chat</title>
		<script src="https://cdn.socket.io/socket.io-1.0.0.js"></script>
		<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles_room.css') }}">
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
		<script>
			document.addEventListener('DOMContentLoaded', function(){
				var socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port);

				socket.on('connect', function(){
					socket.emit('joined_room', {
						username: "{{ username }}",
						channel: "{{ channel }}"
					});

					
					document.querySelector('#sendMessage').onsubmit = function(e){
						e.preventDefault();
						let dateObj = new Date();
						let time = dateObj.getHours() + ":" + dateObj.getMinutes() + ":" + dateObj.getSeconds();
						let message = document.querySelector('#message').value;
						let user = "{{ username }}";

						if(message.length > 0){
							socket.emit('sent_message', {
								username: "{{ username }}",
								channel: "{{ channel }}",
								message: [user, message, time]
							})
						}

						document.querySelector('#message').value = '';
					}

				});

				socket.on('new_user_announce', function(data){
					let userList = document.createElement('li');
					userList.innerHTML = `<strong>${data['username']}</strong> has joined the room`;
					document.querySelector('#currUsers').append(userList);

				});

				socket.on('receiveMessage', function(data){
					let messageDisplay = document.createElement('li');
					let localUser = '{{ username }}';
					let user = data['message'][0];
					let message = data['message'][1];
					let time = data['message'][2];
					if(localUser === user){
						messageDisplay.innerHTML = `<strong>${user}</strong>: ${message} - <i>${time}</i>`;
					}
					else{
						messageDisplay.innerHTML = `<strong>${user}</strong>: ${message} - <i>${time}</i>`;
					}

					
					document.querySelector('#currUsers').append(messageDisplay);
				});

			});
		</script>

	</head>
	<body>
		<nav class="navbar navbar-expand-lg navbar-light bg-light">
			<a class="navbar-brand" href="#">
				<img src="{{ url_for('static', filename='globeIcon.png') }}" width="30" height="30" class="d-inline-block align-center" alt="" loading="lazy">
				Flack
			</a>
		    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
		    	<span class="navbar-toggler-icon"></span>
		    </button>
	    	<div class="collapse navbar-collapse" id="navbarNavAltMarkup">
		    	<div class="navbar-nav">
		    		<a class="nav-item nav-link" href="{{ url_for('index') }}">Home</a>
			        <a class="nav-item nav-link" href="#">About</a>
			        <a class="nav-item nav-link" href="#">Code</a>
	    		</div>
	    	</div>
		</nav>

		<h1>Welcome {{ username }}!</h1>

		<ul id="currUsers">
			{% for i in chatMsgs %}
				{% if i[0] == username %}
					<li><strong>{{ i[0] }}!!!</strong>: {{ i[1] }} - <i>{{ i[2] }}</i></li>
				{% else %}
					<li><strong>{{ i[0] }}</strong>: {{ i[1] }} - <i>{{ i[2] }}</i></li>
				{% endif %}
			{% endfor %}
		</ul>

		<form id="sendMessage">
			<input id="message" type="text" placeholder="Message">
			<button>Send</button>
		</form>
		<br>
		

		<div class="container-fluid h-100">
			<div class="row justify-content-center h-100">
				<div class="col-md-8 col-xl-6 chat">
					<div class="card">
						<div class="card-header msg_head">
							<div class="d-flex bd-highlight">
								<div class="img_cont">
									<img src="{{ url_for('static', filename='person.jpg') }}" class="rounded-circle user_img">
									<span class="online_icon"></span>
								</div>
								<div class="user_info">
									<span>#{{ channel }}</span> <!-- Channel name can go here-->
									<p>1767 Messages</p> <!-- This is where we can put the # of messages-->
								</div>
								
							</div>
						</div>

						<div class="card-body msg_card_body">
							{% for i in chatMsgs %}
								{% if i[0] == username %}
									<div class="d-flex justify-content-end mb-4">
										<div class="msg_cotainer_send">
											{{ i[1] }}
											<span class="msg_time_send">{{ i[2] }}</span>
										</div>
										<div class="img_cont_msg">
											<img src="{{ url_for('static', filename='person.jpg') }}" class="rounded-circle user_img_msg">
										</div>
									</div>
								{% else %}
									<div class="d-flex justify-content-start mb-4">
										<div class="img_cont_msg">
											<img src="{{ url_for('static', filename='person.jpg') }}" class="rounded-circle user_img_msg">
										</div>
										<div class="msg_cotainer">
											{{ i[1] }}
											<span class="msg_time">{{ i[2] }}</span>
										</div>
									</div>
								{% endif %}
							{% endfor %}
						</div>

						<div class="card-footer">
							<div class="input-group">
								<!--
								<div class="input-group-append">
									<span class="input-group-text attach_btn"><i class="fas fa-paperclip"></i></span>
								</div> -->
								
								<textarea name="" class="form-control type_msg" placeholder="Type your message..."></textarea>
								<div class="input-group-append">
									<span class="input-group-text send_btn"><a href="www.google.com"><i class="fas fa-location-arrow icon_arrow"></i></a></span>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<a href="{{ url_for('chats') }}">Go Back to Channels</a>
		<a href="" style="text-decoration: none !important;">hello</a>
	</body>
</html>